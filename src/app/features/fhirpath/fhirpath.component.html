<div class="fhirpath-container">
  <!-- FHIRPath Expression Input -->
  <div class="card mb-3 border-0" style="flex-shrink: 0">
    <div class="card-body p-2">
      <div class="row g-2 align-items-end">
        <div class="col-md-10">
          <label class="form-label small mb-1">FHIRPath Expression</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="expression"
            (keydown)="handleKeyDown($event)"
            placeholder="e.g., name.family, telecom.where(system='phone').value"
            autofocus
          />
        </div>
        <div class="col-md-2">
          <button
            class="btn btn-sm btn-primary w-100"
            (click)="handleExecute()"
            [disabled]="loading() || !expression().trim()">
            @if (loading()) {
              <i class="fas fa-spinner fa-spin me-2"></i>
              Executing...
            } @else {
              <i class="fas fa-bolt me-2"></i>
              Execute
            }
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-danger" role="alert" style="flex-shrink: 0">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error() }}
    </div>
  }

  <!-- Results Card with Split Panel -->
  <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0">
    <app-result-header
      icon="fa-sitemap"
      title="FhirPath Tester"
      [editor]="this.component?.editor"
      [readOnly]="true">
    </app-result-header>

    <div class="card-body flex-grow-1 overflow-hidden p-0" id="fhirpath-container">
      <div class="d-flex h-100" [style.user-select]="isResizing() ? 'none' : 'auto'">
        <!-- Left Panel: JSON Input -->
        <div [style.width.%]="leftWidth()" [style.min-width.%]="leftWidth()" class="h-100 d-flex flex-column">
          <div class="flex-grow-1" style="min-height: 0">
            <app-monaco-editor
              #component
              [value]="jsonInput()"
              (valueChange)="jsonInput.set($event)"
              [language]="'json'"
              [readOnly]="false"
              [theme]="'light'"
            />
          </div>
        </div>

        <!-- Resize Divider -->
        <div
          class="resize-divider"
          [class.resizing]="isResizing()"
          (mousedown)="startResizing($event)">
        </div>

        <!-- Right Panel: Result -->
        <div [style.width.%]="100 - leftWidth()" [style.min-width.%]="100 - leftWidth()" class="h-100 d-flex flex-column">
          @if (result() === null) {
            <div class="text-center text-muted py-5">
              <i class="fas fa-bolt fa-3x mb-3 opacity-50"></i>
              <p>Enter a FHIRPath expression and click Execute to see results.</p>
              <div class="mt-4 text-start p-2">
                <h6>Example Expressions:</h6>
                <ul class="small">
                  <li><code>name.family</code> - Get all family names</li>
                  <li><code>telecom.where(system='phone').value</code> - Get phone numbers</li>
                  <li><code>Patient.birthDate</code> - Get birth date</li>
                  <li><code>entry.resource.ofType(Patient)</code> - Filter Bundle entries</li>
                </ul>
              </div>
            </div>
          } @else {
            <!-- Result Display -->
            <div class="d-flex flex-column h-100">
              <div class="d-flex justify-content-between align-items-center p-2" style="flex-shrink: 0">
                <h6 class="mb-0">Result</h6>
              </div>
              <div class="flex-grow-1" style="min-height: 0">
                <app-monaco-editor
                  [value]="formatResult()"
                  [language]="'json'"
                  [readOnly]="true"
                  [theme]="'light'"
                />
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
