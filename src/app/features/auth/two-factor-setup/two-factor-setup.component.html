<div class="setup-container">
  <div class="setup-card">
    <!-- Header -->
    <div class="setup-header">
      <i class="fas fa-shield-alt brand-icon"></i>
      <h1 class="brand-title">Two-Factor Authentication</h1>
      <p class="brand-subtitle">Add an extra layer of security to your account</p>
    </div>

    <div class="setup-content">
      <!-- 2FA Already Enabled -->
      @if (twoFactorEnabled() && !secret()) {
        <div class="status-message success">
          <i class="fas fa-check-circle"></i>
          <h2>2FA is Enabled</h2>
          <p>Your account is protected with two-factor authentication</p>

          <div class="button-group">
            <button type="button" class="btn btn-outline-danger" (click)="disable2FA()" [disabled]="loading()">
              @if (loading()) {
                <span class="spinner-border spinner-border-sm"></span>
                Disabling...
              } @else {
                <i class="fas fa-times"></i> Disable 2FA
              }
            </button>
            <button type="button" class="btn btn-primary" (click)="backToLogin()">
              <i class="fas fa-arrow-left"></i> Back to Login
            </button>
          </div>
        </div>
      }

      <!-- Setup Complete -->
      @else if (setupComplete()) {
        <div class="status-message success">
          <i class="fas fa-check-circle"></i>
          <h2>Setup Complete!</h2>
          <p>Two-factor authentication has been enabled successfully</p>

          <div class="button-group">
            <button type="button" class="btn btn-outline-primary" (click)="startNewSetup()">
              <i class="fas fa-redo"></i> Setup Another Device
            </button>
            <button type="button" class="btn btn-primary" (click)="backToLogin()">
              <i class="fas fa-arrow-left"></i> Back to Login
            </button>
          </div>
        </div>
      }

      <!-- Setup Flow -->
      @else {
        @if (!secret()) {
          <!-- Step 1: Start Setup -->
          <div class="setup-step">
            <div class="step-number">Step 1</div>
            <h2>Install Authenticator App</h2>
            <p>
              Install an authenticator app on your mobile device if you haven't already:
            </p>

            <ul class="app-list">
              <li><i class="fab fa-google"></i> Google Authenticator</li>
              <li><i class="fab fa-microsoft"></i> Microsoft Authenticator</li>
              <li><i class="fas fa-mobile-alt"></i> Authy</li>
              <li><i class="fas fa-mobile-alt"></i> Any TOTP-compatible app</li>
            </ul>

            <div class="form-group">
              <label class="form-label" for="accountName">
                <i class="fas fa-tag"></i> Account Name (Optional)
              </label>
              <input
                id="accountName"
                type="text"
                class="form-control"
                [ngModel]="accountName()"
                (ngModelChange)="accountName.set($event)"
                placeholder="e.g., My FHIR Account"
              />
              <small class="form-text">This will help you identify the account in your authenticator app</small>
            </div>

            <button type="button" class="btn btn-primary btn-lg w-100" (click)="generate2FASecret()" [disabled]="loading()">
              @if (loading()) {
                <span class="spinner-border spinner-border-sm"></span>
                Generating...
              } @else {
                <i class="fas fa-qrcode"></i> Generate QR Code
              }
            </button>
          </div>
        } @else {
          <!-- Step 2: Scan QR Code -->
          <div class="setup-step">
            <div class="step-number">Step 2</div>
            <h2>Scan QR Code</h2>
            <p>
              Scan this QR code with your authenticator app
            </p>

            <div class="qr-code-container">
              <img [src]="qrCode()" alt="2FA QR Code" class="qr-code" />
            </div>

            <div class="secret-container">
              <label class="form-label">Or enter this code manually:</label>
              <div class="secret-box">
                <code>{{ secret() }}</code>
                <button type="button" class="btn btn-sm btn-outline-primary" (click)="copySecret()">
                  <i class="fas fa-copy"></i> Copy
                </button>
              </div>
            </div>

            <!-- Step 3: Verify -->
            <div class="verification-section">
              <div class="step-number">Step 3</div>
              <h3>Verify Setup</h3>
              <p>Enter the 6-digit code from your authenticator app</p>

              <form (ngSubmit)="verify2FASetup()">
                <div class="form-group">
                  <input
                    type="text"
                    class="form-control code-input"
                    [ngModel]="verificationCode()"
                    (ngModelChange)="verificationCode.set($event)"
                    name="code"
                    placeholder="000000"
                    maxlength="6"
                    pattern="[0-9]{6}"
                    autocomplete="off"
                    required
                  />
                </div>

                @if (error()) {
                  <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ error() }}
                  </div>
                }

                <div class="button-group">
                  <button type="button" class="btn btn-secondary" (click)="startNewSetup()" [disabled]="loading()">
                    <i class="fas fa-redo"></i> Start Over
                  </button>
                  <button type="submit" class="btn btn-primary" [disabled]="loading() || verificationCode().length !== 6">
                    @if (loading()) {
                      <span class="spinner-border spinner-border-sm"></span>
                      Verifying...
                    } @else {
                      <i class="fas fa-check"></i> Verify & Enable
                    }
                  </button>
                </div>
              </form>
            </div>
          </div>
        }

        <div class="setup-footer">
          <button type="button" class="btn btn-link" (click)="backToLogin()">
            <i class="fas fa-arrow-left"></i> Back to Login
          </button>
        </div>
      }

      @if (error() && !secret()) {
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle"></i>
          {{ error() }}
        </div>
      }
    </div>
  </div>
</div>
