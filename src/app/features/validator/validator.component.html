<div class="validator-container">
  <!-- Validation Controls -->
  <div class="card mb-3 border-0" style="flex-shrink: 0">
    <div class="card-body p-2">
      <!-- Row 1: Validation Mode -->
      <div class="row g-2 align-items-end mb-2">
        <div class="col-md-3">
          <label class="form-label small mb-1">Validation Mode</label>
          <select class="form-select form-select-sm" [(ngModel)]="selectedProfile" [disabled]="useServerValidate()">
            <option value="server-capability">Server CapabilityStatement</option>
            <option value="fhir-r4-base">FHIR R4 Base</option>
            <option value="fhir-stu3-base">FHIR STU3 Base</option>
          </select>
        </div>
        <div class="col-md-3">
          <div class="form-check mt-4">
            <input
              type="checkbox"
              class="form-check-input"
              id="serverValidateToggle"
              [checked]="useServerValidate()"
              (change)="onServerValidateToggle($any($event.target).checked)">
            <label class="form-check-label small" for="serverValidateToggle">
              <i class="fas fa-server me-1"></i>
              Use Server $validate
            </label>
          </div>
        </div>
        <div class="col-md-3">
          <button
            class="btn btn-sm btn-outline-secondary w-100"
            (click)="handleClear()"
            [disabled]="!jsonInput() && !validationResult()">
            <i class="fas fa-times me-1"></i>
            Clear
          </button>
        </div>
        <div class="col-md-3">
          <button
            class="btn btn-sm btn-primary w-100"
            (click)="handleValidate()"
            [disabled]="loading() || !parsedData()">
            @if (loading()) {
              <i class="fas fa-spinner fa-spin me-2"></i>
              Validating...
            } @else {
              <i class="fas fa-check-circle me-2"></i>
              Validate Resource
            }
          </button>
        </div>
      </div>

      <!-- Row 2: Profile Selection (only shown when server $validate is enabled) -->
      @if (useServerValidate()) {
        <div class="row g-2 align-items-end">
          <div class="col-md-6">
            <label class="form-label small mb-1">
              <i class="fas fa-file-medical me-1"></i>
              Profile (StructureDefinition)
            </label>
            <div class="input-group input-group-sm">
              <select
                class="form-select form-select-sm"
                [ngModel]="selectedProfileUrl()"
                (ngModelChange)="selectedProfileUrl.set($event); useCustomProfile.set(false)"
                [disabled]="useCustomProfile() || profilesLoading()">
                <option value="">-- No specific profile --</option>
                @for (profile of availableProfiles(); track profile.url) {
                  <option [value]="profile.url">
                    {{ profile.name || profile.title || profile.url }}
                  </option>
                }
              </select>
              <button
                class="btn btn-outline-secondary"
                type="button"
                (click)="refreshProfiles()"
                [disabled]="profilesLoading()"
                title="Refresh profiles">
                @if (profilesLoading()) {
                  <i class="fas fa-spinner fa-spin"></i>
                } @else {
                  <i class="fas fa-sync-alt"></i>
                }
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label small mb-1">
              <i class="fas fa-link me-1"></i>
              Or enter custom profile URL
            </label>
            <div class="input-group input-group-sm">
              <div class="input-group-text">
                <input
                  type="checkbox"
                  class="form-check-input mt-0"
                  [checked]="useCustomProfile()"
                  (change)="useCustomProfile.set($any($event.target).checked)"
                  title="Use custom URL">
              </div>
              <input
                type="text"
                class="form-control form-control-sm"
                placeholder="http://hl7.org/fhir/StructureDefinition/..."
                [ngModel]="customProfileUrl()"
                (ngModelChange)="customProfileUrl.set($event)"
                [disabled]="!useCustomProfile()"
                spellcheck="false">
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Results Card with Split Panel -->
  <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0">
    <app-result-header
      icon="fa-check-circle"
      title="Fhir Validator"
      [editor]="this.component?.editor"
      [readOnly]="false">
    </app-result-header>

    <div class="card-body flex-grow-1 overflow-hidden p-0" id="validator-container">
      <div class="d-flex h-100" [style.user-select]="isResizing() ? 'none' : 'auto'">
        <!-- Left Panel: JSON Input -->
        <div [style.width.%]="leftWidth()" [style.min-width.%]="leftWidth()" class="h-100 d-flex flex-column">

          <div class="d-flex gap-2 align-items-center">

          </div>
          <div class="flex-grow-1" style="min-height: 0">
            <app-monaco-editor #component
              [value]="jsonInput()"
              (valueChange)="jsonInput.set($event)"
              [language]="'json'"
              [readOnly]="false"
              [theme]="'light'"
            />
          </div>
        </div>

        <!-- Resize Divider -->
        <div
          class="resize-divider"
          [class.resizing]="isResizing()"
          (mousedown)="startResizing($event)">
        </div>

        <!-- Right Panel: Validation Results -->
        <div [style.width.%]="100 - leftWidth()" [style.min-width.%]="100 - leftWidth()" class="h-100 overflow-auto p-3">
          <!-- Validation Results -->
          @if (!validationResult()) {
            <div class="text-center text-muted py-5">
              <i class="fas fa-check-circle fa-3x mb-3 opacity-50"></i>
              <p>Load a FHIR resource and click Validate to see results.</p>
            </div>
          } @else {
            <div class="h-100 overflow-austo">
              <!-- Summary Header -->
              <div class="alert mb-3 me-2" [class]="'alert-' + (validationResult()!.isValid ? 'success' : 'danger')">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas" [class]="'fa-' + (validationResult()!.isValid ? 'check-circle' : 'times-circle') + ' me-2'"></i>
                    <strong>{{ validationResult()!.isValid ? 'Valid FHIR Resource' : 'Validation Failed' }}</strong>
                    @if (validationResult()!.resourceType) {
                      <span class="ms-2 text-muted">({{ validationResult()!.resourceType }})</span>
                    }
                  </div>
                  <button class="btn btn-sm btn-outline-secondary" (click)="clearResult()">
                    <i class="fas fa-times me-1"></i>
                    Clear
                  </button>
                </div>

                @if (validationResult()!.issues.length > 0) {
                  <div class="mt-2 small">
                    <strong>Issues Found:</strong>
                    @if (errors().length > 0) {
                      <span class="text-danger">
                        {{ errors().length }} error{{ errors().length !== 1 ? 's' : '' }}
                      </span>
                    }
                    @if (errors().length > 0 && warnings().length > 0) {
                      <span>, </span>
                    }
                    @if (warnings().length > 0) {
                      <span class="text-warning">
                        {{ warnings().length }} warning{{ warnings().length !== 1 ? 's' : '' }}
                      </span>
                    }
                    @if ((errors().length > 0 || warnings().length > 0) && information().length > 0) {
                      <span>, </span>
                    }
                    @if (information().length > 0) {
                      <span class="text-primary pe-1">{{ information().length }} info</span>
                    }
                  </div>
                }
              </div>

              <!-- Issues List -->
              @if (validationResult()!.issues.length === 0) {
                <div class="alert alert-success">
                  <i class="fas fa-thumbs-up me-2"></i>
                  No issues found. Resource conforms to FHIR R4 specification.
                </div>
              } @else {
                <!-- Errors -->
                @if (errors().length > 0) {
                  <div class="mb-4">
                    <h6 class="text-danger mb-3">
                      <i class="fas" [class]="'fa-' + getSeverityIcon('error') + ' me-2'"></i>
                      Errors ({{ errors().length }})
                    </h6>
                    @for (issue of errors(); track $index) {
                      <div class="card border-danger mb-2 me-2">
                        <div class="card-body p-3">
                          <div class="d-flex align-items-start">
                            <i class="fas text-danger me-3 mt-1" [class]="'fa-' + getSeverityIcon(issue.severity)"></i>
                            <div class="flex-grow-1">
                              <div class="fw-bold mb-1">{{ issue.diagnostics }}</div>
                              @if (issue.location && issue.location.length > 0) {
                                <div class="small text-muted">
                                  <i class="fas fa-map-marker-alt me-1"></i>
                                  Location: <code>{{ issue.location.join(', ') }}</code>
                                </div>
                              }
                              @if (issue.code) {
                                <div class="small text-muted mt-1">
                                  <i class="fas fa-tag me-1"></i>
                                  Code: <code>{{ issue.code }}</code>
                                </div>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Warnings -->
                @if (warnings().length > 0) {
                  <div class="mb-4">
                    <h6 class="text-warning mb-3">
                      <i class="fas" [class]="'fa-' + getSeverityIcon('warning') + ' me-2'"></i>
                      Warnings ({{ warnings().length }})
                    </h6>
                    @for (issue of warnings(); track $index) {
                      <div class="card border-warning mb-2 me-2">
                        <div class="card-body p-3">
                          <div class="d-flex align-items-start">
                            <i class="fas text-warning me-3 mt-1" [class]="'fa-' + getSeverityIcon(issue.severity)"></i>
                            <div class="flex-grow-1">
                              <div class="fw-bold mb-1">{{ issue.diagnostics }}</div>
                              @if (issue.location && issue.location.length > 0) {
                                <div class="small text-muted">
                                  <i class="fas fa-map-marker-alt me-1"></i>
                                  Location: <code>{{ issue.location.join(', ') }}</code>
                                </div>
                              }
                              @if (issue.code) {
                                <div class="small text-muted mt-1">
                                  <i class="fas fa-tag me-1"></i>
                                  Code: <code>{{ issue.code }}</code>
                                </div>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Information -->
                @if (information().length > 0) {
                  <div class="mb-4">
                    <h6 class="text-primary mb-3">
                      <i class="fas" [class]="'fa-' + getSeverityIcon('information') + ' me-2'"></i>
                      Information ({{ information().length }})
                    </h6>
                    @for (issue of information(); track $index) {
                      <div class="card border-primary mb-2 me-2">
                        <div class="card-body p-3">
                          <div class="d-flex align-items-start">
                            <i class="fas text-primary me-3 mt-1" [class]="'fa-' + getSeverityIcon(issue.severity)"></i>
                            <div class="flex-grow-1">
                              <div class="fw-bold mb-1">{{ issue.diagnostics }}</div>
                              @if (issue.location && issue.location.length > 0) {
                                <div class="small text-muted">
                                  <i class="fas fa-map-marker-alt me-1"></i>
                                  Location: <code>{{ issue.location.join(', ') }}</code>
                                </div>
                              }
                              @if (issue.code) {
                                <div class="small text-muted mt-1">
                                  <i class="fas fa-tag me-1"></i>
                                  Code: <code>{{ issue.code }}</code>
                                </div>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
              }
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
