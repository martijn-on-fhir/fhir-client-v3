<div class="bulk-container">
  <!-- Header Card with Tabs -->
  <div class="card mb-3 border-0" style="flex-shrink: 0">
    <div class="card-body p-2">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-0">
          <i class="fas fa-exchange-alt me-2"></i>
          Bulk Import / Export
        </h5>

        <!-- Tab Buttons -->
        <ul class="nav nav-tabs border-0">
          <li class="nav-item">
            <a class="nav-link"
               [class.active]="activeTab() === 'export'"
               (click)="setActiveTab('export')"
               href="javascript:void(0)">
              <i class="fas fa-download me-1"></i>
              Export
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link"
               [class.active]="activeTab() === 'import'"
               (click)="setActiveTab('import')"
               href="javascript:void(0)">
              <i class="fas fa-upload me-1"></i>
              Import
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link"
               [class.active]="activeTab() === 'collection'"
               (click)="setActiveTab('collection')"
               href="javascript:void(0)">
              <i class="fas fa-folder-open me-1"></i>
              Collection
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0">
    <div class="card-body flex-grow-1 overflow-auto p-3">

      <!-- ===== IMPORT TAB ===== -->
      @if (activeTab() === 'import') {
        <div class="row">
          <!-- Left Column: File Upload & Options -->
          <div class="col-md-5">
            <!-- Drop Zone -->
            <div class="drop-zone mb-3"
                 [class.drag-over]="isDragOver()"
                 [class.has-file]="fileName()">
              @if (!fileName()) {
                <div class="text-center p-4">
                  <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                  <p class="mb-2">Drag and drop a file here</p>
                  <p class="text-muted small mb-3">Supports JSON array, NDJSON, or FHIR Bundle</p>
                  <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-outline-primary btn-sm" (click)="openFileDialog()">
                      <i class="fas fa-folder-open me-1"></i>
                      Browse Files
                    </button>
                    <label class="btn btn-outline-secondary btn-sm mb-0">
                      <i class="fas fa-file me-1"></i>
                      Select File
                      <input type="file"
                             class="d-none"
                             accept=".json,.ndjson,.jsonl"
                             (change)="onFileSelected($event)">
                    </label>
                  </div>
                </div>
              } @else {
                <div class="text-center p-3">
                  <i class="fas fa-file-code fa-2x mb-2 text-success"></i>
                  <p class="mb-1 fw-bold">{{ fileName() }}</p>
                  <p class="text-muted small mb-2">
                    {{ parsedResources().length }} resource(s) found
                  </p>
                  <button class="btn btn-outline-secondary btn-sm" (click)="clearImport()">
                    <i class="fas fa-times me-1"></i>
                    Clear
                  </button>
                </div>
              }
            </div>

            <!-- Parse Error -->
            @if (parseError()) {
              <div class="alert alert-danger mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ parseError() }}
              </div>
            }

            <!-- Import Options -->
            <div class="card mb-3">
              <div class="card-header py-2">
                <i class="fas fa-cog me-1"></i>
                Import Options
              </div>
              <div class="card-body">
                <!-- Format -->
                <div class="mb-3">
                  <label class="form-label small">File Format</label>
                  <select class="form-select form-select-sm"
                          [ngModel]="importFormat()"
                          (ngModelChange)="importFormat.set($event); onFormatChange()">
                    <option value="json-array">JSON (Array or Bundle)</option>
                    <option value="ndjson">NDJSON (Newline-delimited JSON)</option>
                  </select>
                </div>

                <!-- Dry Run -->
                <div class="form-check mb-2">
                  <input type="checkbox"
                         class="form-check-input"
                         id="dryRun"
                         [checked]="dryRun()"
                         (change)="dryRun.set($any($event.target).checked)">
                  <label class="form-check-label small" for="dryRun">
                    <i class="fas fa-flask me-1"></i>
                    Dry run (validate only, don't import)
                  </label>
                </div>

                <!-- Continue on Error -->
                <div class="form-check">
                  <input type="checkbox"
                         class="form-check-input"
                         id="continueOnError"
                         [checked]="continueOnError()"
                         (change)="continueOnError.set($any($event.target).checked)"
                         [disabled]="dryRun()">
                  <label class="form-check-label small" for="continueOnError">
                    <i class="fas fa-forward me-1"></i>
                    Continue on errors
                  </label>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
              @if (!isRunning()) {
                <button class="btn btn-primary"
                        (click)="startImport()"
                        [disabled]="parsedResources().length === 0">
                  <i class="fas fa-upload me-2"></i>
                  @if (dryRun()) {
                    Validate {{ parsedResources().length }} Resource(s)
                  } @else {
                    Import {{ parsedResources().length }} Resource(s)
                  }
                </button>
              } @else {
                <button class="btn btn-danger" (click)="cancelOperation()">
                  <i class="fas fa-stop me-2"></i>
                  Cancel
                </button>
              }
            </div>
          </div>

          <!-- Right Column: Progress & Results -->
          <div class="col-md-7">
            <!-- Progress Section -->
            @if (progress()) {
              <div class="card mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                  <span>
                    <i class="fas fa-tasks me-1"></i>
                    Progress
                  </span>
                  @if (progress()!.currentResource) {
                    <small class="text-muted">
                      Processing: {{ progress()!.currentResource }}
                    </small>
                  }
                </div>
                <div class="card-body">
                  <!-- Progress Bar -->
                  <div class="progress mb-3" style="height: 24px;">
                    <div class="progress-bar"
                         [class.progress-bar-striped]="isRunning()"
                         [class.progress-bar-animated]="isRunning()"
                         [class.bg-success]="progress()!.isComplete && progress()!.failed === 0"
                         [class.bg-warning]="progress()!.isComplete && progress()!.failed > 0"
                         [style.width.%]="progressPercent()"
                         role="progressbar">
                      {{ progressPercent() }}%
                    </div>
                  </div>

                  <!-- Stats -->
                  <div class="row text-center">
                    <div class="col">
                      <div class="h4 mb-0">{{ progress()!.processed }}</div>
                      <small class="text-muted">Processed</small>
                    </div>
                    <div class="col">
                      <div class="h4 mb-0 text-success">{{ progress()!.succeeded }}</div>
                      <small class="text-muted">Succeeded</small>
                    </div>
                    <div class="col">
                      <div class="h4 mb-0 text-danger">{{ progress()!.failed }}</div>
                      <small class="text-muted">Failed</small>
                    </div>
                    @if (dryRun()) {
                      <div class="col">
                        <div class="h4 mb-0 text-warning">{{ progress()!.skipped }}</div>
                        <small class="text-muted">Invalid</small>
                      </div>
                    }
                  </div>

                  @if (progress()!.isCancelled) {
                    <div class="alert alert-warning mt-3 mb-0">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Operation was cancelled
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Error Results -->
            @if (failedResults().length > 0) {
              <div class="card">
                <div class="card-header py-2 bg-danger text-white">
                  <i class="fas fa-times-circle me-1"></i>
                  Errors ({{ failedResults().length }})
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th style="width: 60px;">#</th>
                        <th style="width: 120px;">Resource</th>
                        <th>Error</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (result of failedResults(); track result.index) {
                        <tr>
                          <td>{{ result.index + 1 }}</td>
                          <td>
                            <span class="badge" [class]="getStatusClass(result.status)">
                              {{ result.resourceType }}
                            </span>
                          </td>
                          <td class="small text-danger">{{ result.error }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            }

            <!-- Empty State -->
            @if (!progress() && !parseError()) {
              <div class="text-center text-muted py-5">
                <i class="fas fa-file-import fa-3x mb-3 opacity-50"></i>
                <p>Select a file to start importing resources</p>
              </div>
            }
          </div>
        </div>
      }

      <!-- ===== EXPORT TAB ===== -->
      @if (activeTab() === 'export') {
        <div class="row">
          <!-- Left Column: Export Options -->
          <div class="col-md-5">
            <div class="card mb-3">
              <div class="card-header py-2">
                <i class="fas fa-cog me-1"></i>
                Export Options
              </div>
              <div class="card-body">
                <!-- Resource Type -->
                <div class="mb-3">
                  <label class="form-label small">Resource Type</label>
                  <select class="form-select form-select-sm"
                          [ngModel]="exportResourceType()"
                          (ngModelChange)="exportResourceType.set($event)"
                          [disabled]="loadingResourceTypes()">
                    <option value="">All Resource Types</option>
                    @for (type of resourceTypes(); track type) {
                      <option [value]="type">{{ type }}</option>
                    }
                  </select>
                  @if (loadingResourceTypes()) {
                    <small class="text-muted">
                      <i class="fas fa-spinner fa-spin me-1"></i>
                      Loading...
                    </small>
                  }
                </div>

                <!-- Max Resources -->
                <div class="mb-3">
                  <label class="form-label small">Maximum Resources</label>
                  <input type="number"
                         class="form-control form-control-sm"
                         [ngModel]="maxResources()"
                         (ngModelChange)="maxResources.set($event)"
                         min="0"
                         placeholder="0 = unlimited">
                  <small class="text-muted">Set to 0 for unlimited</small>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
              @if (!isRunning()) {
                <button class="btn btn-primary" (click)="startExport()">
                  <i class="fas fa-download me-2"></i>
                  Start Export
                </button>
              } @else {
                <button class="btn btn-danger" (click)="cancelOperation()">
                  <i class="fas fa-stop me-2"></i>
                  Cancel
                </button>
              }
            </div>
          </div>

          <!-- Right Column: Progress & Results -->
          <div class="col-md-7">
            <!-- Progress Section -->
            @if (progress()) {
              <div class="card mb-3">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                  <span>
                    <i class="fas fa-tasks me-1"></i>
                    Export Progress
                  </span>
                  @if (progress()!.currentResource) {
                    <small class="text-muted">
                      Exporting: {{ progress()!.currentResource }}
                    </small>
                  }
                </div>
                <div class="card-body">
                  <!-- Progress Bar -->
                  <div class="progress mb-3" style="height: 24px;">
                    @if (progress()!.total === 0 && isRunning()) {
                      <div class="progress-bar bg-warning text-dark"
                           style="width: 100%"
                           role="progressbar">
                        {{ progress()!.currentResource || 'Counting resources...' }}
                      </div>
                    } @else if (isRunning()) {
                      <div class="progress-bar bg-primary"
                           [style.width.%]="progressPercent()"
                           role="progressbar">
                        {{ progressPercent() }}% ({{ progress()!.succeeded }} / {{ progress()!.total }})
                      </div>
                    } @else {
                      <div class="progress-bar bg-success"
                           [style.width.%]="100"
                           role="progressbar">
                        {{ progress()!.succeeded }} resources
                      </div>
                    }
                  </div>

                  <!-- Stats -->
                  <div class="row text-center">
                    <div class="col">
                      <div class="h4 mb-0 text-success">{{ progress()!.succeeded }}</div>
                      <small class="text-muted">Resources Exported</small>
                    </div>
                    @if (progress()!.total > 0) {
                      <div class="col">
                        <div class="h4 mb-0 text-primary">{{ progress()!.total }}</div>
                        <small class="text-muted">Total Expected</small>
                      </div>
                    }
                  </div>

                  @if (progress()!.isCancelled) {
                    <div class="alert alert-warning mt-3 mb-0">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      Export was cancelled
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Export Result -->
            @if (hasExportData()) {
              <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                  <span>
                    <i class="fas fa-check-circle text-success me-1"></i>
                    Export Complete
                  </span>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="saveExport()">
                      <i class="fas fa-save me-1"></i>
                      Save to File
                    </button>
                    <button class="btn btn-outline-danger" (click)="clearExport()">
                      <i class="fas fa-times me-1"></i>
                      Clear
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <p class="mb-2">
                    <strong>{{ exportedCount() }}</strong> resources ready for download
                  </p>

                  <!-- Preview Info -->
                  @if (exportSample().length > 0) {
                    <div class="mb-2">
                      <small class="text-muted">
                        <i class="fas fa-eye me-1"></i>
                        Preview (showing first {{ exportSample().length }} of {{ exportedCount() }}):
                      </small>
                    </div>
                  }

                  <!-- Resource Type Summary (from sample) -->
                  <div class="small text-muted">
                    @for (type of getResourceTypeSummary(); track type.type) {
                      <span class="badge bg-secondary me-1 mb-1">
                        {{ type.type }}: {{ type.count }}
                      </span>
                    }
                    @if (exportHasMore()) {
                      <span class="text-muted small">(based on preview sample)</span>
                    }
                  </div>

                  <!-- Note about temp file -->
                  <div class="mt-2">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      Data is stored in a temporary file. Click "Save to File" to save it permanently.
                    </small>
                  </div>
                </div>
              </div>
            }

            <!-- Empty State -->
            @if (!progress() && !hasExportData()) {
              <div class="text-center text-muted py-5">
                <i class="fas fa-file-export fa-3x mb-3 opacity-50"></i>
                <p>Configure export options and click Start Export</p>
              </div>
            }
          </div>
        </div>
      }

      <!-- ===== COLLECTION EXPORT TAB ===== -->
      @if (activeTab() === 'collection') {
        <div class="row">
          <!-- Left Column: Collection Options -->
          <div class="col-md-5">
            <div class="card mb-3">
              <div class="card-header py-2">
                <i class="fas fa-cog me-1"></i>
                Collection Options
              </div>
              <div class="card-body">
                <!-- Collection Name -->
                <div class="mb-3">
                  <label class="form-label small">Collection Name</label>
                  <input type="text"
                         class="form-control form-control-sm"
                         [ngModel]="collectionName()"
                         (ngModelChange)="collectionName.set($event)"
                         placeholder="FHIR API Collection">
                </div>

                <!-- Export Format -->
                <div class="mb-3">
                  <label class="form-label small">Export Format</label>
                  <select class="form-select form-select-sm"
                          [ngModel]="collectionFormat()"
                          (ngModelChange)="collectionFormat.set($event)">
                    <option value="postman">Postman Collection (v2.1)</option>
                    <option value="openapi">OpenAPI 3.0 Spec</option>
                    <option value="insomnia">Insomnia v4</option>
                  </select>
                </div>

                <!-- Query Source -->
                <div class="mb-3">
                  <label class="form-label small">Query Source</label>
                  <select class="form-select form-select-sm"
                          [ngModel]="collectionSource()"
                          (ngModelChange)="collectionSource.set($event)">
                    <option value="favorites">Favorites ({{ getSourceQueryCount() }} queries)</option>
                    <option value="history">Query History ({{ getSourceQueryCount() }} queries)</option>
                    <option value="server-capabilities">Server Capabilities (CRUD for all types)</option>
                  </select>
                  <small class="text-muted">
                    @if (collectionSource() === 'favorites') {
                      Export your bookmarked queries
                    } @else if (collectionSource() === 'history') {
                      Export recent query history
                    } @else {
                      Generate CRUD operations for all resource types
                    }
                  </small>
                </div>

                <!-- Include Auth -->
                <div class="form-check mb-2">
                  <input type="checkbox"
                         class="form-check-input"
                         id="includeAuth"
                         [checked]="collectionIncludeAuth()"
                         (change)="collectionIncludeAuth.set($any($event.target).checked)">
                  <label class="form-check-label small" for="includeAuth">
                    <i class="fas fa-lock me-1"></i>
                    Include authentication scheme
                  </label>
                </div>
              </div>
            </div>

            <!-- Format Info -->
            <div class="card mb-3">
              <div class="card-header py-2">
                <i class="fas fa-info-circle me-1"></i>
                Format Info
              </div>
              <div class="card-body small">
                @if (collectionFormat() === 'postman') {
                  <p class="mb-1"><strong>Postman Collection v2.1</strong></p>
                  <p class="text-muted mb-0">
                    Import directly into Postman. Includes folders per resource type,
                    FHIR headers, and query parameters.
                  </p>
                } @else if (collectionFormat() === 'openapi') {
                  <p class="mb-1"><strong>OpenAPI 3.0 Specification</strong></p>
                  <p class="text-muted mb-0">
                    Standard API documentation format. Use with Swagger UI,
                    code generators, or API gateways.
                  </p>
                } @else {
                  <p class="mb-1"><strong>Insomnia v4 Export</strong></p>
                  <p class="text-muted mb-0">
                    Import into Insomnia REST client. Includes workspaces,
                    environments, and request groups.
                  </p>
                }
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
              <button class="btn btn-primary"
                      (click)="generateCollectionExport()"
                      [disabled]="generatingCollection() || getSourceQueryCount() === 0">
                @if (generatingCollection()) {
                  <i class="fas fa-spinner fa-spin me-2"></i>
                  Generating...
                } @else {
                  <i class="fas fa-magic me-2"></i>
                  Generate Collection
                }
              </button>
            </div>
          </div>

          <!-- Right Column: Preview & Download -->
          <div class="col-md-7">
            @if (hasCollection()) {
              <div class="card">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                  <span>
                    <i class="fas fa-check-circle text-success me-1"></i>
                    Collection Generated
                  </span>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" (click)="saveCollection()">
                      <i class="fas fa-save me-1"></i>
                      Save
                    </button>
                    <button class="btn btn-outline-secondary" (click)="copyCollection()">
                      <i class="fas fa-copy me-1"></i>
                      Copy
                    </button>
                    <button class="btn btn-outline-danger" (click)="clearCollection()">
                      <i class="fas fa-times me-1"></i>
                      Clear
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <span class="badge bg-primary me-2">
                      {{ collectionFormat() | uppercase }}
                    </span>
                    <span class="badge bg-secondary">
                      {{ collectionQueryCount() }} queries
                    </span>
                  </div>

                  <!-- Preview -->
                  <div class="border rounded p-2 bg-light" style="max-height: 400px; overflow: auto;">
                    <pre class="mb-0 small"><code>{{ generatedCollection() }}</code></pre>
                  </div>
                </div>
              </div>
            } @else {
              <!-- Empty State -->
              <div class="text-center text-muted py-5">
                <i class="fas fa-folder-open fa-3x mb-3 opacity-50"></i>
                <p class="mb-2">Export queries as API collections</p>
                <p class="small">
                  Generate Postman, OpenAPI, or Insomnia collections from your
                  favorites, history, or server capabilities.
                </p>
              </div>
            }
          </div>
        </div>
      }

    </div>
  </div>
</div>
