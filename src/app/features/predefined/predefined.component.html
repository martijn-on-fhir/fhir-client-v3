<div class="predefined-container">
  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-danger m-3 mb-0">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error() }}
    </div>
  }

  <!-- Toolbar -->
  <div class="px-3 py-2" style="flex-shrink: 0">
    <div class="row g-2">
      <!-- Left: Search and Category -->
      <div class="col-4">
        <div class="row g-2">
          <div class="col-8">
            <div class="input-group input-group-sm">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Search templates..."
                [ngModel]="searchQuery()"
                (ngModelChange)="searchQuery.set($event)">
              @if (searchQuery()) {
                <button class="btn btn-outline-secondary" (click)="searchQuery.set('')">
                  <i class="fas fa-times"></i>
                </button>
              }
            </div>
          </div>
          <div class="col-4">
            <select
              class="form-select form-select-sm"
              [ngModel]="selectedCategory()"
              (ngModelChange)="selectedCategory.set($event)">
              <option value="all">All Categories</option>
              @for (cat of categories; track cat.id) {
                <option [value]="cat.id">{{ cat.label }}</option>
              }
            </select>
          </div>
        </div>
      </div>

      <!-- Right: Action Buttons -->
      <div class="col-8">
        <div class="d-flex gap-2 justify-content-end align-items-center">
          <button class="btn btn-sm btn-outline-secondary" (click)="importTemplate()">
            <i class="fas fa-upload me-2"></i>Import Template
          </button>
          <button class="btn btn-sm btn-primary" (click)="openNewTemplate()">
            <i class="fas fa-plus me-2"></i>New Template
          </button>
          @if (selectedTemplate()) {
            <button class="btn btn-sm btn-outline-secondary" (click)="editTemplate(selectedTemplate()!)">
              <i class="fas fa-edit me-2"></i>Edit
            </button>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Split Panel Container -->
  <div class="flex-grow-1 overflow-hidden" id="predefined-container">
    <div class="d-flex h-100">
      <!-- Left Panel: Template Browser -->
      <div [style.width.%]="leftWidth()" class="h-100 border-end overflow-auto p-3">
        <app-template-browser
          [templates]="filteredTemplates()"
          [selectedTemplate]="selectedTemplate()"
          [searchQuery]="searchQuery()"
          [selectedCategory]="selectedCategory()"
          (selectTemplate)="selectTemplate($event)"
          (editTemplate)="editTemplate($event)"
          (deleteTemplate)="deleteTemplate($event)"
          (exportTemplate)="exportTemplate($event)">
        </app-template-browser>
      </div>

      <!-- Resizable Divider -->
      <div
        (mousedown)="startResizing($event)"
        [style.background-color]="isResizing() ? '#6c757d' : '#dee2e6'"
        style="width: 2px; min-width: 2px; cursor: col-resize; flex-shrink: 0"></div>

      <!-- Right Panel: Query Results -->
      <div [style.width.%]="100 - leftWidth()" class="h-100 d-flex flex-column p-3">
        <!-- Generated Query Display -->
        <div class="mb-3">
          <h6 class="small mb-2">
            <i class="fas fa-search me-2"></i>Generated Query
          </h6>
          <div class="p-2 border rounded font-monospace small" style="word-break: break-all; min-height: 2.5rem; background-color: var(--bs-secondary-bg);">
            @if (currentQuery()) {
              {{ currentQuery() }}
            } @else {
              <span class="text-muted">No query generated yet</span>
            }
          </div>
          <div class="d-flex gap-2 mt-2">
            <button
              class="btn btn-primary btn-sm flex-grow-1"
              (click)="executeQuery(currentQuery())"
              [disabled]="loading() || !currentQuery()">
              <i class="fas fa-bolt me-2"></i>
              {{ loading() ? 'Executing...' : 'Execute Query' }}
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              (click)="copyQuery()"
              [disabled]="!currentQuery()">
              <i class="fas fa-copy me-2"></i>Copy
            </button>
          </div>
        </div>

        <!-- Results Card -->
        <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-file-lines me-2"></i>Result</span>

            @if (result() && !loading()) {
              <app-json-viewer-toolbar
                [editor]="this.component?.editor"
                [readOnly]="true">
              </app-json-viewer-toolbar>
            }
          </div>
          <div class="card-body p-0 d-flex flex-column" style="flex: 1; min-height: 0; overflow: hidden;">
            @if (!result() && !loading()) {
              <div class="d-flex flex-column align-items-center justify-content-center h-100 p-3">
                <i class="fas fa-play-circle fa-3x mb-3 text-muted" style="opacity: 0.3"></i>
                <p class="text-muted text-center">Select a template from the left panel and configure it to execute a query.</p>
              </div>
            }

            @if (loading()) {
              <div class="d-flex justify-content-center align-items-center h-100 p-3">
                <div class="spinner-border text-primary"></div>
              </div>
            }

            @if (result() && !loading()) {
              <div style="flex: 1; display: flex; min-height: 0;">
                <app-monaco-editor #component
                  [value]="jsonContent()"
                  [language]="'json'"
                  [readOnly]="true">
                </app-monaco-editor>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Config Dialog -->
  <app-template-config-dialog
    [isOpen]="showConfigDialog()"
    [template]="selectedTemplate()"
    (close)="closeConfigDialog()"
    (execute)="handleTemplateExecution($event)">
  </app-template-config-dialog>

  <!-- Template Editor Dialog -->
  <app-template-editor-dialog
    [isOpen]="showEditorDialog()"
    [template]="editingTemplate()"
    (close)="showEditorDialog.set(false)"
    (save)="saveTemplate($event)">
  </app-template-editor-dialog>

  <!-- Confirmation Dialog -->
  <app-confirmation-dialog
    [isOpen]="showConfirmDialog()"
    [title]="confirmDialogConfig().title"
    [message]="confirmDialogConfig().message"
    [confirmText]="confirmDialogConfig().confirmText"
    [cancelText]="confirmDialogConfig().cancelText"
    [confirmButtonClass]="confirmDialogConfig().confirmButtonClass"
    [icon]="confirmDialogConfig().icon"
    (confirm)="handleConfirmDialogConfirm()"
    (cancel)="handleConfirmDialogCancel()">
  </app-confirmation-dialog>
</div>
