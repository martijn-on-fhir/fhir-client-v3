<div class="narratives-container">
  <!-- Selection Form -->
  <div class="card mb-3 border-0" style="flex-shrink: 0">
    <div class="card-body p-2">
      <div class="d-flex gap-2 align-items-center">
        <!-- Profile Dropdown -->
        <div style="flex: 1">
          <select
            class="form-select"
            (change)="onProfileChange($event)"
            [disabled]="nictizService.isLoading() || nictizService.structureDefinitions().length === 0">
            <option value="">
              {{ nictizService.isLoading() ? '-- Loading profiles... --' : '-- Select Nictiz Profile --' }}
            </option>
            @for (profile of getSortedProfiles(); track profile.url) {
              <option [value]="profile.url" [selected]="profile.url === selectedProfileUrl()">
                {{ getProfileDisplayName(profile.title) }}
              </option>
            }
          </select>
        </div>

        <!-- Execute Button -->
        <button class="btn btn-sm btn-primary" [disabled]="!selectedProfileUrl()">
          <i class="fas fa-bolt me-2"></i>
          Execute
        </button>

        <!-- Create Button (only when no content) -->
        @if (!editorContent()) {
          <button class="btn btn-sm btn-success" [disabled]="!selectedProfileUrl()">
            <i class="fas fa-plus me-2"></i>
            Create
          </button>
        }

        <!-- Update Button (only when content exists) -->
        @if (editorContent()) {
          <button class="btn btn-sm btn-success" [disabled]="!selectedProfileUrl()">
            <i class="fas fa-edit me-2"></i>
            Update
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Result Panel -->
  <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0">
    <!-- Result Header with Toolbar -->
    <app-result-header
      icon="fa-book-open"
      [title]="selectedProfileTitle() || 'Narratives'"
      [editor]="monacoEditor?.editor"
      [readOnly]="true">
    </app-result-header>

    <div class="card-body p-0 d-flex flex-column" style="overflow: hidden; flex: 1">
      <!-- Loading profiles overlay -->
      @if (nictizService.isLoading()) {
        <div class="loading-overlay">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Loading Nictiz profiles from server...</p>
        </div>
      }

      <!-- Error loading profiles -->
      @if (nictizService.error()) {
        <div class="p-3">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ nictizService.error() }}
          </div>
          <button class="btn btn-primary" (click)="nictizService.fetchStructureDefinitions()">
            <i class="fas fa-sync me-2"></i>
            Retry
          </button>
        </div>
      }

      <!-- Loading template overlay -->
      @if (loadingTemplate()) {
        <div class="loading-overlay">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Loading template...</p>
        </div>
      }

      <!-- Template info/error -->
      @if (templateError()) {
        <div class="p-3">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            {{ templateError() }}
          </div>
        </div>
      }

      <!-- Monaco Editor (always visible, read-only) -->
      <div class="flex-grow-1" style="min-height: 0">
        <app-monaco-editor #monacoEditor
          [value]="editorContent()"
          [readOnly]="true"
          language="handlebars">
        </app-monaco-editor>
      </div>
    </div>
  </div>
</div>
