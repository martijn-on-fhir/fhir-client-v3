@if (show()) {
  <!-- Full-screen modal backdrop -->
  <div class="modal-backdrop d-block"></div>

  <!-- Full-screen modal -->
  <div class="modal d-block" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <!-- Header -->
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-{{ isEditing() ? 'edit' : 'plus' }} me-2"></i>
            {{ isEditing() ? 'Edit' : 'Create' }} {{ resourceType() }}
          </h5>
          <div class="d-flex gap-2">
            <button type="button" class="btn-close" (click)="closeDialog()"></button>
          </div>
        </div>

        <!-- Body with 3-panel layout -->
        <div class="modal-body p-0" id="resource-editor-container">
          <div class="d-flex h-100">
            <!-- Left Panel: Properties Browser -->
            <div [style.width.%]="leftWidth()" class="panel properties-panel">
              <div class="panel-header">
                <div class="row">
                  <div class="12">
                    <h6 class="mb-0">
                      <i class="fas fa-list me-2"></i>Properties
                    </h6>
                  </div>
                </div>

                <div class="row">
                  <div class="col-auto">
                    <!-- Search/Filter Input -->
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      placeholder="Search properties..."
                      style="max-width: 200px;"
                      [value]="propertySearchQuery()"
                      (input)="propertySearchQuery.set($any($event.target).value)"
                    />
                  </div>
                </div>
              </div>
              <div class="panel-body">
                <!-- Required Properties -->
                <h6 class="properties-header mb-3 mt-2 ms-2">Required Properties</h6>
                @if (filteredRequiredProperties().length === 0) {
                  <p class="text-muted small">
                    @if (propertySearchQuery()) {
                      No matching required properties
                    } @else {
                      No required properties
                    }
                  </p>
                } @else {
                  <div class="accordion" id="requiredPropertiesAccordion">
                    @for (prop of filteredRequiredProperties(); track prop.path; let i = $index) {
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button
                            class="accordion-button"
                            [class.collapsed]="expandedRequiredIndex() !== i"
                            type="button"
                            (click)="toggleRequiredAccordion(i)">
                            <i class="far fa-file me-2"></i>
                            {{ prop.name }}
                          </button>
                        </h2>
                        <div
                          class="accordion-collapse collapse"
                          [class.show]="expandedRequiredIndex() === i">
                          <div class="accordion-body">
                            @if (prop.short) {
                              <p class="small mb-2"><strong>{{ prop.short }}</strong></p>
                            }
                            @if (prop.definition) {
                              <p class="small text-muted mb-2">{{ prop.definition }}</p>
                            }
                            @if (!prop.short && !prop.definition) {
                              <p class="small text-muted mb-2">No description available</p>
                            }

                            <!-- Display allowed reference types if this is a Reference property -->
                            @if (isReferenceType(prop)) {
                              <div class="mb-2">
                                <span class="small text-muted">
                                  <strong>Allowed References:</strong><br/>
                                  {{ getAllowedReferences(prop) }}
                                </span>
                              </div>
                            }

                            <div class="mt-2 d-flex align-items-center justify-content-between">
                              <span class="badge bg-secondary">{{ getCardinality(prop) }}</span>
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                style="padding: 0.125rem 0.375rem; font-size: 0.75rem"
                                (click)="addProperty(prop)">
                                <i class="fas fa-plus"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Optional Properties -->
                <h6 class="properties-header mb-3 mt-4 ms-2">Optional Properties</h6>
                @if (filteredOptionalProperties().length === 0) {
                  <p class="text-muted small">
                    @if (propertySearchQuery()) {
                      No matching optional properties
                    } @else {
                      No optional properties
                    }
                  </p>
                } @else {
                  <div class="accordion" id="optionalPropertiesAccordion">
                    @for (prop of filteredOptionalProperties(); track prop.path; let i = $index) {
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button
                            class="accordion-button"
                            [class.collapsed]="expandedOptionalIndex() !== i"
                            type="button"
                            (click)="toggleOptionalAccordion(i)">
                            <i class="far fa-file me-2"></i>
                            {{ prop.name }}
                          </button>
                        </h2>
                        <div
                          class="accordion-collapse collapse"
                          [class.show]="expandedOptionalIndex() === i">
                          <div class="accordion-body">
                            @if (prop.short) {
                              <p class="small mb-2"><strong>{{ prop.short }}</strong></p>
                            }
                            @if (prop.definition) {
                              <p class="small text-muted mb-2">{{ prop.definition }}</p>
                            }
                            @if (!prop.short && !prop.definition) {
                              <p class="small text-muted mb-2">No description available</p>
                            }

                            <!-- Display allowed reference types if this is a Reference property -->
                            @if (isReferenceType(prop)) {
                              <div class="mb-2">
                                <span class="small text-muted">
                                  <strong>Allowed References:</strong><br/>
                                  {{ getAllowedReferences(prop) }}
                                </span>
                              </div>
                            }

                            <div class="mt-2 d-flex align-items-center justify-content-between">
                              <span class="badge bg-secondary">{{ getCardinality(prop) }}</span>
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                style="padding: 0.125rem 0.375rem; font-size: 0.75rem"
                                (click)="addProperty(prop)">
                                <i class="fas fa-plus"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Left Resize Handle -->
            <div
              (mousedown)="startResizeLeft($event)"
              [style.background-color]="isResizingLeft() ? '#6c757d' : '#dee2e6'"
              style="width: 2px; min-width: 2px; cursor: col-resize; flex-shrink: 0"></div>

            <!-- Center Panel: Monaco Editor -->
            <div [style.width.%]="centerWidth()" class="panel editor-panel">
              <div class="panel-header">
                <h6 class="mb-0">
                  <i class="fas fa-code me-2"></i>JSON Editor
                </h6>
                <div class="d-flex gap-2 align-items-center">
                  <app-json-viewer-toolbar
                    [editor]="this.component?.editor"
                    [generateNarrative]="true"
                    [readOnly]="true">
                  </app-json-viewer-toolbar>
                </div>
              </div>
              <div class="panel-body p-0">
                <app-monaco-editor #component
                  [value]="editorContent()"
                  (valueChange)="editorContent.set($event)"
                  [language]="'json'"
                  [readOnly]="false"
                  [autocompleteConfig]="autocompleteConfig()"
                  (altEnterPressed)="handleAltEnter($event)">
                </app-monaco-editor>
              </div>
            </div>

            <!-- Right Resize Handle -->
            <div
              (mousedown)="startResizeRight($event)"
              [style.background-color]="isResizingRight() ? '#6c757d' : '#dee2e6'"
              style="width: 2px; min-width: 2px; cursor: col-resize; flex-shrink: 0"></div>

            <!-- Right Panel: Validation & Info -->
            <div [style.width.%]="rightWidth()" class="panel validation-panel">
              <div class="panel-header">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-2"></i>Information
                </h6>
              </div>
              <div class="panel-body p-2">
                <!-- Info Cards - Only show when not showing validation results -->
                @if (!showValidationResults()) {
                  <!-- Description Card -->
                  @if (sdDescription()) {
                    <div class="card mb-3">
                      <div class="card-body">
                        <h6 class="card-title">
                          <i class="fas fa-align-left me-2"></i>Description
                        </h6>
                        <p class="card-text small">{{ sdDescription() }}</p>
                      </div>
                    </div>
                  }

                  <!-- Purpose Card -->
                  @if (sdPurpose()) {
                    <div class="card mb-3">
                      <div class="card-body">
                        <h6 class="card-title">
                          <i class="fas fa-bullseye me-2"></i>Purpose
                        </h6>
                        <p class="card-text small">{{ sdPurpose() }}</p>
                      </div>
                    </div>
                  }

                  <!-- Keyboard Shortcuts Card -->
                  <div class="card mb-3">
                    <div class="card-body">
                      <h6 class="card-title">
                        <i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts
                      </h6>
                      <table class="table table-sm small mb-0">
                        <tbody>
                        <tr>
                          <td style="width: 50%"><kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>L</kbd></td>
                          <td>Format JSON</td>
                        </tr>
                        <tr>
                          <td><kbd>Alt</kbd>+<kbd>Enter</kbd></td>
                          <td>Reference Selector</td>
                        </tr>
                        <tr>
                          <td><kbd>Ctrl</kbd>+<kbd>↓</kbd></td>
                          <td>Next empty value</td>
                        </tr>
                        <tr>
                          <td><kbd>Ctrl</kbd>+<kbd>↑</kbd></td>
                          <td>Previous empty value</td>
                        </tr>
                        <tr>
                          <td><kbd>Ctrl</kbd>+<kbd>F</kbd></td>
                          <td>Find in editor</td>
                        </tr>
                        <tr>
                          <td><kbd>Escape</kbd></td>
                          <td>Close dialog</td>
                        </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                }

                <!-- Validation Results - Only show when validation has been triggered -->
                @if (showValidationResults()) {
                  <!-- Validation Error -->
                  @if (validationError()) {
                    <div class="alert alert-danger">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      {{ validationError() }}
                    </div>
                  }

                  <!-- Validation Loading -->
                  @if (validationLoading()) {
                    <div class="text-center p-3">
                      <div class="spinner-border text-primary"></div>
                    </div>
                  }

                  <!-- Validation Results -->
                  @if (validationResult() && !validationLoading()) {
                    <div class="validation-results">
                      <!-- Errors -->
                      @if (getIssuesBySeverity('error'); as errors) {
                        @if (errors.length > 0) {
                          <div class="issue-section">
                            <h6 class="issue-section-header text-danger">
                              <i class="fas fa-times-circle me-2"></i>
                              Errors ({{ errors.length }})
                            </h6>
                            @for (issue of errors; track $index) {
                              <div class="card mb-2">
                                <div class="card-body p-2">
                                  <div class="d-flex align-items-start gap-2">
                                    <span class="badge bg-danger">
                                      <i class="fas fa-times-circle"></i>
                                    </span>
                                    <div class="flex-grow-1">
                                      <div class="issue-location small text-muted mb-1">{{ issue.location?.[0] || 'Unknown' }}</div>
                                      <div class="issue-message small">{{ issue.diagnostics || issue.details?.text }}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      }

                      <!-- Warnings -->
                      @if (getIssuesBySeverity('warning'); as warnings) {
                        @if (warnings.length > 0) {
                          <div class="issue-section">
                            <h6 class="issue-section-header text-warning">
                              <i class="fas fa-exclamation-triangle me-2"></i>
                              Warnings ({{ warnings.length }})
                            </h6>
                            @for (issue of warnings; track $index) {
                              <div class="card mb-2">
                                <div class="card-body p-2">
                                  <div class="d-flex align-items-start gap-2">
                                    <span class="badge bg-warning text-dark">
                                      <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                    <div class="flex-grow-1">
                                      <div class="issue-location small text-muted mb-1">{{ issue.location?.[0] || 'Unknown' }}</div>
                                      <div class="issue-message small">{{ issue.diagnostics || issue.details?.text }}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      }

                      <!-- Information -->
                      @if (getIssuesBySeverity('information'); as info) {
                        @if (info.length > 0) {
                          <div class="issue-section">
                            <h6 class="issue-section-header text-info">
                              <i class="fas fa-info-circle me-2"></i>
                              Information ({{ info.length }})
                            </h6>
                            @for (issue of info; track $index) {
                              <div class="card mb-2">
                                <div class="card-body p-2">
                                  <div class="d-flex align-items-start gap-2">
                                    <span class="badge bg-info text-dark">
                                      <i class="fas fa-info-circle"></i>
                                    </span>
                                    <div class="flex-grow-1">
                                      <div class="issue-location small text-muted mb-1">{{ issue.location?.[0] || 'Unknown' }}</div>
                                      <div class="issue-message small">{{ issue.diagnostics || issue.details?.text }}</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      }

                      <!-- Success (no issues) -->
                      @if (validationResult().issue?.length === 0) {
                        <div class="card mb-2">
                          <div class="card-body p-2">
                            <div class="d-flex align-items-center gap-2">
                              <span class="badge bg-success">
                                <i class="fas fa-check-circle"></i> Success
                              </span>
                              <span class="small">Resource is valid!</span>
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  }
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <!-- Save Error -->
          @if (saveError()) {
            <div class="alert alert-danger mb-0 me-auto">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ saveError() }}
            </div>
          }

          <button type="button" class="btn btn-sm btn-primary" (click)="validateResource()"
            [disabled]="validationLoading()">
            @if (validationLoading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Validating...
            } @else {
              <i class="fas fa-check-circle me-2"></i>
              Validate
            }
          </button>
          <button type="button" class="btn btn-sm btn-success" (click)="saveResource()" [disabled]="saveLoading()">
            @if (saveLoading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              {{ isEditing() ? 'Updating...' : 'Creating...' }}
            } @else {
              <i class="fas fa-save me-2"></i>
              {{ isEditing() ? 'Update' : 'Create' }}
            }
          </button>
          <button type="button" class="btn btn-sm btn-danger" (click)="closeDialog()">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reference Selector Dialog -->
  <app-reference-selector-dialog
    (select)="handleReferenceSelect($event)">
  </app-reference-selector-dialog>
}
