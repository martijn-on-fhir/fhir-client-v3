@if (show()) {
  <!-- Full-screen modal backdrop -->
  <div class="modal-backdrop d-block" style="background: rgba(0,0,0,0.5)"></div>

  <!-- Full-screen modal -->
  <div class="modal d-block" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <!-- Header -->
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-{{ isEditing() ? 'edit' : 'plus' }} me-2"></i>
            {{ isEditing() ? 'Edit' : 'Create' }} {{ resourceType() }}
          </h5>
          <div class="d-flex gap-2">
            @if (structureDefinition()) {
              <span class="badge bg-secondary">{{ structureDefinition()!.title || structureDefinition()!.name }}</span>
            }
            <button type="button" class="btn-close" (click)="closeDialog()"></button>
          </div>
        </div>

        <!-- Body with 3-panel layout -->
        <div class="modal-body p-0" id="resource-editor-container">
          <div class="d-flex h-100">
            <!-- Left Panel: Properties Browser -->
            <div [style.width.%]="leftWidth()" class="panel properties-panel">
              <div class="panel-header">
                <h6 class="mb-0">
                  <i class="fas fa-list me-2"></i>Properties
                </h6>
              </div>
              <div class="panel-body">
                <!-- Search/Filter Input -->
                <div class="px-2 p-2">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    placeholder="Search properties..."
                    [value]="propertySearchQuery()"
                    (input)="propertySearchQuery.set($any($event.target).value)"
                  />
                </div>
                <!-- Required Properties -->
                <h6 class="properties-header">Required Properties</h6>
                @if (filteredRequiredProperties().length === 0) {
                  <p class="text-muted small px-2">
                    @if (propertySearchQuery()) {
                      No matching required properties
                    } @else {
                      No required properties
                    }
                  </p>
                } @else {
                  <div class="accordion" id="requiredPropertiesAccordion">
                    @for (prop of filteredRequiredProperties(); track prop.path; let i = $index) {
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button
                            class="accordion-button"
                            [class.collapsed]="i !== 0"
                            type="button"
                            [attr.data-bs-toggle]="'collapse'"
                            [attr.data-bs-target]="'#requiredCollapse' + i"
                            [attr.aria-expanded]="i === 0"
                            [attr.aria-controls]="'requiredCollapse' + i">
                            <i class="far fa-file me-2"></i>
                            {{ prop.name }}
                          </button>
                        </h2>
                        <div
                          [id]="'requiredCollapse' + i"
                          class="accordion-collapse collapse"
                          [class.show]="i === 0"
                          [attr.data-bs-parent]="'#requiredPropertiesAccordion'">
                          <div class="accordion-body">
                            @if (prop.short) {
                              <p class="small mb-2"><strong>{{ prop.short }}</strong></p>
                            }
                            @if (prop.definition) {
                              <p class="small text-muted mb-2">{{ prop.definition }}</p>
                            }
                            @if (!prop.short && !prop.definition) {
                              <p class="small text-muted mb-2">No description available</p>
                            }

                            <!-- Display allowed reference types if this is a Reference property -->
                            @if (isReferenceType(prop)) {
                              <div class="mb-2">
                                <span class="small text-muted">
                                  <strong>Allowed References:</strong><br/>
                                  {{ getAllowedReferences(prop) }}
                                </span>
                              </div>
                            }

                            <div class="mt-2 d-flex align-items-center justify-content-between">
                              <span class="badge bg-secondary">{{ getCardinality(prop) }}</span>
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                style="padding: 0.125rem 0.375rem; font-size: 0.75rem"
                                (click)="addProperty(prop)">
                                <i class="fas fa-plus"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Optional Properties -->
                <h6 class="properties-header">Optional Properties</h6>
                @if (filteredOptionalProperties().length === 0) {
                  <p class="text-muted small px-2">
                    @if (propertySearchQuery()) {
                      No matching optional properties
                    } @else {
                      No optional properties
                    }
                  </p>
                } @else {
                  <div class="accordion" id="optionalPropertiesAccordion">
                    @for (prop of filteredOptionalProperties(); track prop.path; let i = $index) {
                      <div class="accordion-item">
                        <h2 class="accordion-header">
                          <button
                            class="accordion-button collapsed"
                            type="button"
                            [attr.data-bs-toggle]="'collapse'"
                            [attr.data-bs-target]="'#optionalCollapse' + i"
                            [attr.aria-expanded]="false"
                            [attr.aria-controls]="'optionalCollapse' + i">
                            <i class="far fa-file me-2"></i>
                            {{ prop.name }}
                          </button>
                        </h2>
                        <div
                          [id]="'optionalCollapse' + i"
                          class="accordion-collapse collapse"
                          [attr.data-bs-parent]="'#optionalPropertiesAccordion'">
                          <div class="accordion-body">
                            @if (prop.short) {
                              <p class="small mb-2"><strong>{{ prop.short }}</strong></p>
                            }
                            @if (prop.definition) {
                              <p class="small text-muted mb-2">{{ prop.definition }}</p>
                            }
                            @if (!prop.short && !prop.definition) {
                              <p class="small text-muted mb-2">No description available</p>
                            }

                            <!-- Display allowed reference types if this is a Reference property -->
                            @if (isReferenceType(prop)) {
                              <div class="mb-2">
                                <span class="small text-muted">
                                  <strong>Allowed References:</strong><br/>
                                  {{ getAllowedReferences(prop) }}
                                </span>
                              </div>
                            }

                            <div class="mt-2 d-flex align-items-center justify-content-between">
                              <span class="badge bg-secondary">{{ getCardinality(prop) }}</span>
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-secondary"
                                style="padding: 0.125rem 0.375rem; font-size: 0.75rem"
                                (click)="addProperty(prop)">
                                <i class="fas fa-plus"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Left Resize Handle -->
            <div
              (mousedown)="startResizeLeft($event)"
              [style.background-color]="isResizingLeft() ? '#6c757d' : '#dee2e6'"
              style="width: 2px; min-width: 2px; cursor: col-resize; flex-shrink: 0"></div>

            <!-- Center Panel: Monaco Editor -->
            <div [style.width.%]="centerWidth()" class="panel editor-panel">
              <div class="panel-header">
                <h6 class="mb-0">
                  <i class="fas fa-code me-2"></i>JSON Editor
                </h6>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-sm btn-outline-secondary"
                    (click)="formatJson()"
                    title="Format JSON (Ctrl+Alt+L)">
                    <i class="fas fa-indent me-1"></i>Format
                  </button>
                  <button
                    class="btn btn-sm btn-outline-info"
                    (click)="toggleKeyboardShortcuts()"
                    title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard"></i>
                  </button>
                </div>
              </div>
              <div class="panel-body p-0">
                <app-monaco-editor
                  [value]="editorContent()"
                  (valueChange)="editorContent.set($event)"
                  [language]="'json'"
                  [readOnly]="false"
                  [autocompleteConfig]="autocompleteConfig()"
                  (altEnterPressed)="handleAltEnter($event)">
                </app-monaco-editor>
              </div>
            </div>

            <!-- Right Resize Handle -->
            <div
              (mousedown)="startResizeRight($event)"
              [style.background-color]="isResizingRight() ? '#6c757d' : '#dee2e6'"
              style="width: 2px; min-width: 2px; cursor: col-resize; flex-shrink: 0"></div>

            <!-- Right Panel: Validation & Info -->
            <div [style.width.%]="rightWidth()" class="panel validation-panel">
              <div class="panel-header">
                <h6 class="mb-0">
                  <i class="fas fa-check-circle me-2"></i>Validation
                </h6>
                <button
                  class="btn btn-sm btn-outline-primary"
                  (click)="validateResource()"
                  [disabled]="validationLoading()">
                  @if (validationLoading()) {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    Validating...
                  } @else {
                    <i class="fas fa-play me-1"></i>Validate
                  }
                </button>
              </div>
              <div class="panel-body">
                <!-- Validation Error -->
                @if (validationError()) {
                  <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ validationError() }}
                  </div>
                }

                <!-- Validation Loading -->
                @if (validationLoading()) {
                  <div class="text-center p-3">
                    <div class="spinner-border text-primary"></div>
                  </div>
                }

                <!-- Validation Results -->
                @if (validationResult() && !validationLoading()) {
                  <div class="validation-results">
                    <!-- Errors -->
                    @if (getIssuesBySeverity('error'); as errors) {
                      @if (errors.length > 0) {
                        <div class="issue-section">
                          <h6 class="issue-section-header text-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Errors ({{ errors.length }})
                          </h6>
                          @for (issue of errors; track $index) {
                            <div class="issue-item alert alert-danger">
                              <div class="issue-location">{{ issue.location?.[0] || 'Unknown' }}</div>
                              <div class="issue-message">{{ issue.diagnostics || issue.details?.text }}</div>
                            </div>
                          }
                        </div>
                      }
                    }

                    <!-- Warnings -->
                    @if (getIssuesBySeverity('warning'); as warnings) {
                      @if (warnings.length > 0) {
                        <div class="issue-section">
                          <h6 class="issue-section-header text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Warnings ({{ warnings.length }})
                          </h6>
                          @for (issue of warnings; track $index) {
                            <div class="issue-item alert alert-warning">
                              <div class="issue-location">{{ issue.location?.[0] || 'Unknown' }}</div>
                              <div class="issue-message">{{ issue.diagnostics || issue.details?.text }}</div>
                            </div>
                          }
                        </div>
                      }
                    }

                    <!-- Information -->
                    @if (getIssuesBySeverity('information'); as info) {
                      @if (info.length > 0) {
                        <div class="issue-section">
                          <h6 class="issue-section-header text-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Information ({{ info.length }})
                          </h6>
                          @for (issue of info; track $index) {
                            <div class="issue-item alert alert-info">
                              <div class="issue-location">{{ issue.location?.[0] || 'Unknown' }}</div>
                              <div class="issue-message">{{ issue.diagnostics || issue.details?.text }}</div>
                            </div>
                          }
                        </div>
                      }
                    }

                    <!-- Success (no issues) -->
                    @if (validationResult().issue?.length === 0) {
                      <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Resource is valid!
                      </div>
                    }
                  </div>
                }

                <!-- No validation yet -->
                @if (!validationResult() && !validationLoading() && !validationError()) {
                  <div class="text-center text-muted p-3">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p>Click Validate to check your resource</p>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <!-- Save Error -->
          @if (saveError()) {
            <div class="alert alert-danger mb-0 me-auto">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ saveError() }}
            </div>
          }

          <button type="button" class="btn btn-secondary" (click)="closeDialog()">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            (click)="saveResource()"
            [disabled]="saveLoading()">
            @if (saveLoading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              {{ isEditing() ? 'Updating...' : 'Creating...' }}
            } @else {
              <i class="fas fa-save me-2"></i>
              {{ isEditing() ? 'Update' : 'Create' }}
            }
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reference Selector Dialog -->
  <app-reference-selector-dialog
    (select)="handleReferenceSelect($event)">
  </app-reference-selector-dialog>

  <!-- Keyboard Shortcuts Help Modal -->
  @if (showKeyboardShortcuts()) {
    <div class="modal-backdrop d-block" style="background: rgba(0,0,0,0.5); z-index: 1070"></div>
    <div class="modal d-block" style="z-index: 1071" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-keyboard me-2"></i>
              Keyboard Shortcuts
            </h5>
            <button type="button" class="btn-close" (click)="toggleKeyboardShortcuts()"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th style="width: 40%">Shortcut</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>Ctrl</kbd> + <kbd>Alt</kbd> + <kbd>L</kbd></td>
                    <td>Format JSON</td>
                  </tr>
                  <tr>
                    <td><kbd>Alt</kbd> + <kbd>Enter</kbd></td>
                    <td>Open Reference Selector (on Reference properties)</td>
                  </tr>
                  <tr>
                    <td><kbd>Ctrl</kbd> + <kbd>↓</kbd></td>
                    <td>Navigate to next empty value</td>
                  </tr>
                  <tr>
                    <td><kbd>Ctrl</kbd> + <kbd>↑</kbd></td>
                    <td>Navigate to previous empty value</td>
                  </tr>
                  <tr>
                    <td><kbd>"</kbd></td>
                    <td>Trigger property name autocomplete</td>
                  </tr>
                  <tr>
                    <td><kbd>Enter</kbd></td>
                    <td>Smart comma insertion after brackets</td>
                  </tr>
                  <tr>
                    <td><kbd>,</kbd></td>
                    <td>Auto-format JSON (if valid)</td>
                  </tr>
                  <tr>
                    <td><kbd>Escape</kbd></td>
                    <td>Close dialog</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="alert alert-info mt-3 mb-0">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Tip:</strong> Use the Properties panel on the left to quickly add fields,
              then use Ctrl+↓ to jump through empty values and fill them in!
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="toggleKeyboardShortcuts()">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  }
}
